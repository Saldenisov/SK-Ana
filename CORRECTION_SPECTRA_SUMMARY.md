# Correction Spectra ALS Extension - Complete Summary\n\n## What Was Created\n\nA complete, non-invasive extension to SK-Ana that implements MCR-ALS with **correction spectra** (coupled fixed + deviation pairs).\n\n### Key Feature\n\nWhen you load fixed reference spectra and enable \"Correction Spectra\":\n- k = 2n + a total components\n  - n fixed spectra (shape-constrained references)\n  - n correction spectra (orthogonal deviations, zero-mean, small)\n  - a free spectra (standard ALS)\n- Correction kinetics **locked to fixed kinetics** (same time profile, different amplitude)\n- Original ALS code **completely unchanged**\n\n---\n\n## Files Created (3 new files, 1 UI file)\n\n### 1. Core Algorithm\n**File:** `server_files/ALS_CorrectionSpectra.R` (494 lines)\n\n**Functions:**\n- `getC_Coupled()` – Solve for C with pairwise coupling\n- `getS_Coupled()` – Solve for S with orthogonality constraints\n- `myals_Coupled()` – Main ALS loop with coupling\n- `als_Coupled()` – Sequential dimension growth wrapper\n\n**Key mechanisms:**\n- Pairwise projection: C_corr = α × C_fix (same kinetic profile)\n- Orthogonalization: S_corr ⟂ S_fix (removes parallel component)\n- Zero-mean: mean(S_corr) = 0 (prevents baseline behavior)\n- Regularization: Tikhonov penalty on ||S_corr||² (via λ parameter)\n\n### 2. UI Panel\n**File:** `ui_files/ALSInputConstraintsCorrectionSpectra.R` (97 lines)\n\n**UI Elements:**\n- Checkbox: \"Enable correction spectra\" (appears when fixed spectra loaded)\n- Slider: \"Correction penalty (λ)\" from -4 to 0 (λ = 10^value)\n- Checkbox: \"Zero-mean corrections\"\n- Help text with interpretation guide\n\n**Behavior:**\n- Conditionally displayed (only when S0 fixed spectra exist)\n- Nested within existing ALS Constraints → Spectra panel\n- Clean, integrated design\n\n### 3. Server Integration\n**File:** `server_files/ALS_CorrectionSpectra_Server.R` (276 lines)\n\n**Purpose:** Routes ALS computation to correct function\n\n**Logic:**\n```\nUser clicks \"Run ALS\"\n  ↓\nCheck: useCorrectionSpectra && nFixed > 0?\n  ├─ YES → load ALS_CorrectionSpectra.R, call als_Coupled()\n  └─ NO → call als() [standard]\n  ↓\nExecute in background (callr::r_bg)\n  ↓\nReturn results\n```\n\n**Key parameters passed:**\n- `nFixed` – number of fixed spectra (from S0)\n- `useCorrectionSpectra` – enable correction mode\n- `lambdaCorr` – Tikhonov regularization (10^slider_value)\n\n### 4. Documentation\n\n#### Full Manual\n**File:** `docs/correction_spectra.md` (190 lines)\n- Mathematical model with equations\n- 3-step usage workflow\n- Parameter interpretation guide\n- Troubleshooting section\n- Output file format\n- References\n\n#### Integration Guide\n**File:** `CORRECTION_SPECTRA_INTEGRATION.md` (208 lines)\n- Installation steps\n- File locations\n- Backward compatibility notes\n- Parameter reference\n- Customization guide\n\n#### Quick Start\n**File:** `QUICKSTART_CORRECTION_SPECTRA.md` (116 lines)\n- 30-second setup\n- 3-step first use\n- Parameter quick reference\n- Troubleshooting table\n\n---\n\n## Files Modified (2 minimal changes)\n\n### 1. server.R\n**Location:** Line 68 (in file list)\n**Change:** Added one line\n```r\n\"ALS_CorrectionSpectra_Server.R\",  # Correction spectra extension (must be after ALS.R)\n```\n**Effect:** Loads server extension after standard ALS\n\n### 2. ui_files/ALSInputConstraintsSpectra.R\n**Location:** End of file (line 87)\n**Change:** Added one line\n```r\n# Correction spectra extension\nsource('ui_files/ALSInputConstraintsCorrectionSpectra.R')\n```\n**Effect:** Includes new UI panel (conditionally displayed)\n\n---\n\n## Mathematical Details\n\n### Model\n```\nX = [C_fix  C_corr  C_free] × [S_fix^T]\n                               [S_corr^T]\n                               [S_free^T]\n```\n\n### Constraints\n\n**Concentrations (C-step):**\n- Solve NNLS: min ||X - C S^T||²\n- **Coupling:** C_corr[:, i] ← project onto C_fix[:, i] direction\n  - Ensures: C_corr[:, i] = α_i × C_fix[:, i]\n  - Meaning: Same temporal behavior, different amplitude\n\n**Spectra (S-step):**\n- Solve NNLS: min ||X - C S^T||²\n- **Orthogonality:** S_corr - proj(S_corr onto S_fix)\n  - Removes parallel component\n  - Ensures corrections explain deviations, not redundancy\n- **Zero-mean:** S_corr ← S_corr - mean(S_corr)\n  - Prevents baseline-like behavior\n- **Regularization:** Tikhonov penalty λ ||S_corr||₂\n  - Controls correction magnitude\n  - λ = 10^(slider value), default -2\n\n---\n\n## Usage Workflow\n\n```\n1. Load data (normal SK-Ana process)\n   ↓\n2. ALS Constraints → Spectra → \"Fix spectral shape(s)\"\n   Upload reference spectrum file(s)\n   ↓\n3. \"Correction Spectra\" panel appears automatically\n   ├─ Check \"Enable correction spectra\"\n   ├─ Set λ slider (default -2 is good)\n   └─ Keep \"Zero-mean corrections\" ON\n   ↓\n4. Set total \"# Spectra\" = nFixed + nFixed + nFree\n   Example: 2 + 2 + 1 = 5 dimensions\n   ↓\n5. Click \"Run ALS\"\n   ├─ Detects: correction spectra enabled ✓\n   ├─ nFixed = 2 ✓\n   ├─ Loads ALS_CorrectionSpectra.R ✓\n   ├─ Calls als_Coupled() with n_Fixed=2, lambdaCorr=10^-2\n   └─ Runs in background\n   ↓\n6. Results:\n   S_1, C_1 → Fixed spectrum 1\n   S_2, C_2 → Fixed spectrum 2\n   S_3, C_3 → Correction for spectrum 1 (C_3 ∝ C_1)\n   S_4, C_4 → Correction for spectrum 2 (C_4 ∝ C_2)\n   S_5, C_5 → Free spectrum\n   ↓\n7. Interpret results:\n   - If S_3, S_4 ≈ 0 → References perfect\n   - If S_3, S_4 have structure → References have errors\n```\n\n---\n\n## Backward Compatibility\n\n✅ **100% backward compatible**\n\n- Standard ALS unchanged (all in separate functions)\n- UI panel only appears when fixed spectra loaded\n- If correction spectra NOT enabled → uses standard `als()`\n- If S0 = NULL → uses standard `als()`\n- All existing ALS features work normally\n- No breaking changes to data structures\n\n---\n\n## Testing Checklist\n\nBefore deployment:\n\n- [ ] Restart Shiny app\n- [ ] Load data and go to ALS Constraints → Spectra\n- [ ] Verify \"Correction Spectra\" panel appears only after loading fixed spectra\n- [ ] Test with correction spectra DISABLED → should use standard ALS\n- [ ] Test with correction spectra ENABLED:\n  - [ ] Try λ = -4, -2, 0 (check results differ)\n  - [ ] Try with/without zero-mean (observe difference)\n  - [ ] Verify C_corr proportional to C_fix\n  - [ ] Verify S_corr orthogonal to S_fix\n- [ ] Test ambiguity explorer with correction spectra results\n- [ ] Save/download results\n- [ ] Check output file format (should have all k components)\n\n---\n\n## File Structure\n\n```\nC:\\dev\\SK-Ana\\\n├─ server.R                                    [MODIFIED: +1 line]\n├─ ui.R                                        (unchanged)\n├─ CORRECTION_SPECTRA_SUMMARY.md              [NEW: this file]\n├─ CORRECTION_SPECTRA_INTEGRATION.md          [NEW]\n├─ QUICKSTART_CORRECTION_SPECTRA.md           [NEW]\n├─ server_files/\n│  ├─ ALS.R                                   (unchanged)\n│  ├─ ALS_CorrectionSpectra.R                 [NEW: 494 lines]\n│  ├─ ALS_CorrectionSpectra_Server.R          [NEW: 276 lines]\n│  ├─ ALS_plots.R                             (unchanged)\n│  └─ ... (other server files)\n├─ ui_files/\n│  ├─ ALSInputConstraintsSpectra.R            [MODIFIED: +2 lines]\n│  ├─ ALSInputConstraintsCorrectionSpectra.R  [NEW: 97 lines]\n│  └─ ... (other UI files)\n├─ docs/\n│  ├─ als.md                                  (existing)\n│  ├─ correction_spectra.md                   [NEW: 190 lines]\n│  └─ ... (other docs)\n└─ outputDir/\n   └─ (results with S_1, S_2, ... S_k)\n```\n\n---\n\n## Support & Resources\n\n**Quick questions?** → See `QUICKSTART_CORRECTION_SPECTRA.md`\n\n**How to integrate?** → See `CORRECTION_SPECTRA_INTEGRATION.md`\n\n**Full details?** → See `docs/correction_spectra.md`\n\n**Code questions?** → Consult function comments in `server_files/ALS_CorrectionSpectra.R`\n\n---\n\n## Summary Statistics\n\n| Metric | Value |\n|--------|-------|\n| New Python/R code | ~867 lines (algorithm + UI) |\n| Documentation | ~514 lines |\n| Code files created | 3 |\n| UI files created | 1 |\n| Files modified | 2 (1 line each) |\n| Backward compatibility | 100% ✅ |\n| Test coverage needed | Yes (see checklist) |\n\n---\n\n**Status: Ready for use. Restart app and test!** ✨\n