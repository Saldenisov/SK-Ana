---
title: "SK-Ana Report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    fig_height: 5
    fig_width: 10
    number_sections: yes
    theme: cerulean
  pdf_document:
    fig_height: 5
    fig_width: 7
    number_sections: yes
  word_document:
    fig_height: 5
    fig_width: 7
fontsize: 11pt
---

```{r, results='asis', echo=FALSE}
cat('# Project name :',input$projectTag)
cex=1
mar=c(4,4,2,1)
mgp=c(2,.75,0)
pty='s'
tcl=-0.5
scale = 0.5 # for multiplots
```
__Data file(s)__ :`r Inputs$fileOrig`


```{r, results='asis', echo=FALSE}
#getData()
if(input$keepCbl!=0) {
  cat('## Baseline correction\n')
  cat('__Delay range__ :', signif(c(min(Inputs$delay),
                                    input$delay[input$keepCbl]),
                                  3))
}
```

## Selected data

__Wavelength range__ : `r signif(range(Inputs$wavl),3)`

__Delay range__ : `r signif(range(Inputs$delay),3)`

```{r echo=FALSE}
par(mfrow=c(1,2),cex=cex, mar=mar,mgp=mgp,pty=pty,tcl=tcl)
image(Inputs$delay,Inputs$wavl,Inputs$mat,
      xlab='Delay',ylab='Wavelength',
      col = imgColors, zlim=input$keepDoRange)
frame()
```


```{r results='asis', echo=FALSE}
if('SVD' %in% input$inReport){
  cat ('# Singular Values Decomposition')
  s<-doSVD()
  if (!is.null(s))
    CS = reshapeCS(s$u,s$v,ncol(s$u))
}
```

```{r echo=FALSE}
if('SVD' %in% input$inReport) {
  if (!is.null(s)){
  mat <- Inputs$mat
  # Suppress masked areas
  mat <- mat[!is.na(Inputs$delayMask), ]
  mat <- mat[, !is.na(Inputs$wavlMask) ]
  plotSvdLof(s,mat,cex=scale)
  }
}
```

```{r echo=FALSE}
if('SVD' %in% input$inReport) {
  if (!is.null(s))
    plotSVDVecBloc(CS$C,CS$S,Inputs$delay,Inputs$wavl,cex=scale)    
}
```

```{r results='asis', echo=FALSE}
if ("ALS" %in% input$inReport) {
  cat("# ALS Decomposition\n\n")
  if (!is.null(alsOut <- doALS())) {
    cat("__Number of components__ : ", input$nALS, "\n\n")
    cat("__Results__ after ", alsOut$iter, " iterations\n\n")
    cat(alsOut$msg)
    CS <- reshapeCS(alsOut$C, alsOut$S, ncol(alsOut$C))
  }
}
```

```{r results='asis', echo=FALSE}
if('ALS' %in% input$inReport){
  cat ('## Spectra and Kinetics')
}
```

```{r echo=FALSE}
if('ALS' %in% input$inReport) {
  if (!is.null(alsOut)){
    par(mfrow=c(1,2))
    plotAlsVec(alsOut,type="Sp" ,cex=scale)
    plotAlsVec(alsOut,type="Kin",cex=scale)
  }
}
```

```{r results='asis', echo=FALSE}
if('ALS' %in% input$inReport){
  cat ('## Residuals')
}
```


```{r echo=FALSE, fig.height=7}
if('ALS' %in% input$inReport) {
  if (!is.null(alsOut)){
    plotResid(Inputs$delay,Inputs$wavl,Inputs$mat,
              CS$C,CS$S,cex=scale)
  }
}
```

```{r results='asis', echo=FALSE}
if('ALS' %in% input$inReport){
  cat ('## Contributions')
}
```

```{r echo=FALSE, fig.height=7}
if('ALS' %in% input$inReport) {
  if (!is.null(alsOut)){
    plotConbtribs(Inputs$delay,Inputs$wavl,Inputs$mat,
                  CS$C,CS$S,cex=scale)
  }
}
```

```{r results='asis', echo=FALSE}
if('ALS' %in% input$inReport){
  cat ('## Rotational Ambiguity')
}
```


```{r amb, echo=FALSE}
if('ALS' %in% input$inReport) {
  if (!is.null(alsOut)) {
    if (!is.list(solutions <- doAmbRot())) {
      cat(paste0("No solutions found \n"))
    } 
    else {
      par(mfrow=c(1,2))
      plotAmbVec(alsOut,solutions,type = "Sp",cex=scale)
      plotAmbVec(alsOut,solutions,type = "Kin",cex=scale)
    }
  }
}
```

******

# Session Info

```{r, echo=FALSE}
sessionInfo()
```
